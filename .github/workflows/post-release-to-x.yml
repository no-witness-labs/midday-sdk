name: Post Release to X

on:
  workflow_run:
    workflows: ["Release"]
    types: [completed]
  workflow_dispatch:

jobs:
  notify:
    runs-on: ubuntu-latest
    # Run if: workflow_dispatch (manual) OR workflow_run completed successfully
    if: ${{ github.event_name == 'workflow_dispatch' || github.event.workflow_run.conclusion == 'success' }}
    steps:
      - name: Get latest release with changes
        id: release
        run: |
          # Get the latest release with actual changes (not just dependency updates)
          RELEASES=$(gh api /repos/${{ github.repository }}/releases --jq '[.[] | select(.tag_name | startswith("v"))]')

          TAG=""
          URL=""

          for i in $(seq 0 10); do
            RELEASE=$(echo $RELEASES | jq ".[$i]")
            if [ "$RELEASE" = "null" ]; then
              break
            fi

            CREATED=$(echo $RELEASE | jq -r .created_at)
            CREATED_TIMESTAMP=$(date -d "$CREATED" +%s)
            NOW=$(date +%s)
            AGE=$((NOW - CREATED_TIMESTAMP))

            # If created in last hour, check if it has real changes (not just dependency updates)
            if [ $AGE -lt 3600 ]; then
              BODY=$(echo $RELEASE | jq -r .body)
              RELEASE_TAG=$(echo $RELEASE | jq -r .tag_name)
              RELEASE_URL=$(echo $RELEASE | jq -r .html_url)

              # Check for actual changes (not just "Updated dependencies")
              CHANGES_SECTION=$(echo "$BODY" | grep -A 100 "Patch Changes\|Minor Changes\|Major Changes" | tail -n +2)
              REAL_CHANGES=$(echo "$CHANGES_SECTION" | grep -v "Updated dependencies" | grep -v "^[[:space:]]*-[[:space:]]*@" | grep -v "^[[:space:]]*$" | head -1)

              if [ -n "$REAL_CHANGES" ]; then
                TAG=$RELEASE_TAG
                URL=$RELEASE_URL
                break
              fi
            fi
          done

          if [ -n "$TAG" ]; then
            echo "tag=$TAG" >> $GITHUB_OUTPUT
            echo "url=$URL" >> $GITHUB_OUTPUT
            echo "found=true" >> $GITHUB_OUTPUT
          else
            echo "found=false" >> $GITHUB_OUTPUT
          fi
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Tweet new release
        if: steps.release.outputs.found == 'true'
        uses: nearform-actions/github-action-notify-twitter@v1
        with:
          message: |
            Midday SDK ${{ steps.release.outputs.tag }} out now
            ${{ steps.release.outputs.url }}
            Happy building!
          twitter-app-key: ${{ secrets.TWITTER_API_KEY }}
          twitter-app-secret: ${{ secrets.TWITTER_API_SECRET }}
          twitter-access-token: ${{ secrets.TWITTER_ACCESS_TOKEN }}
          twitter-access-token-secret: ${{ secrets.TWITTER_ACCESS_TOKEN_SECRET }}
